#!/usr/bin/env python
import sys
from fabric.api import *
from fabric.contrib.files import exists, append

project_name    = 'technicmocs'
env.user        = 'masterbuilder'
env.host_string = 'technicmocs.created.today'

def deploy():
    # Get the necessary packages
    apt_install('build-essential ruby ruby-dev git tcl nginx')
    gem_install('bundler rake uwsgi')
    github('antirez/redis')
    github('antirez/lamernews')

    # Build and install Redis
    with cd('redis'):
        run('git checkout 3.0.1')
        run('make')
        #run('make test')
        sudo('make install')
    sudo('adduser --system --group --quiet --home /var/local/lib/redis redis')
    put('redis.service', '/etc/systemd/system/redis.service', use_sudo=True)
    put('redis.conf', '/etc/redis.conf', use_sudo=True)
    sudo('systemctl daemon-reload')
    sudo('systemctl enable redis')
    sudo('systemctl start redis')

    # Setup the Lamernews app
    with cd('lamernews'):
        run('sed -i "/ruby \'1.9.3\'/d" Gemfile')
        rubyrun('bundle install')
        put('app_config.rb', 'app_config.rb')

    # Configure uwsgi
    sudo('cp /srv/%s/gems/bin/uwsgi /usr/local/bin')
    sudo('mkdir -p /etc/uwsgi')
    put('uwsgi.ini', '/etc/uwsgi/%s.ini' % project_name, use_sudo=True)
    put('uwsgi.service', '/etc/systemd/system/uwsgi.service', use_sudo=True)
    sudo('systemctl daemon-reload')
    sudo('systemctl enable uwsgi')
    sudo('systemctl start uwsgi')

    # Configure nginx
    put('nginx.conf', '/etc/nginx/sites-enabled/%s' % project_name, use_sudo=True)
    sudo('systemctl reload nginx')

def apt_install(packages):
    if command_fails('dpkg -l %s' % packages):
        sudo('apt-get install %s' % packages)

def gem_install(packages):
    packages = packages.split(' ')
    for package in packages:
        if ruby_command_fails('gem list -i %s' % package):
            rubyrun('gem install %s' % package)

def github(repo):
    directory = repo.split('/')[-1]
    if not exists(directory):
        run('git clone https://github.com/%s %s' % (repo, directory))

def command_fails(command):
    with settings(hide('warnings'), warn_only=True):
        return run(command).failed

def ruby_command_fails(command):
    with settings(hide('warnings'), warn_only=True):
        return rubyrun(command).failed

def rubyrun(command):
    with shell_env(GEM_HOME='/srv/%s/gems' % project_name):
        run(command)

if __name__ == '__main__':
    deploy()
